name: Pre-Shared-Infrastructure Deployment Pipeline

trigger:
  - master

pool:
  vmImage: ubuntu-latest

resources:
  repositories:
    - repository: azure-devops-templates
      type: github
      name: hmcts/azure-devops-templates
      ref: refs/heads/master
      endpoint: hmcts
    - repository: terraform-module-postgresql-flexible
      type: github
      name: hmcts/terraform-module-postgresql-flexible
      ref: refs/heads/master
      endpoint: hmcts
    - repository: cnp-module-key-vault
      type: github
      name: hmcts/cnp-module-key-vault
      ref: refs/heads/master
      endpoint: hmcts 
    - repository: terraform-module-log-analytics-workspace-id
      type: github
      name: hmcts/terraform-module-log-analytics-workspace-id
      ref: refs/heads/master
      endpoint: hmcts 
    - repository: cnp-module-storage-account
      type: github
      name: hmcts/cnp-module-storage-account
      ref: refs/heads/master
      endpoint: hmcts 
    - repository: terraform-module-dynatrace-oneagent
      type: github
      name: hmcts/terraform-module-dynatrace-oneagent
      ref: refs/heads/master
      endpoint: hmcts

variables:
  - name: resourceGroup
    value: jenkins-state-${{ lower(parameters.environment) }}
  - name: storageAccount
    value: sdsstate${{ lower(parameters.environment) }}
  - name: container
    value: tfstate-${{ lower(parameters.environment) }}
  - name: serviceConnection
    value: DTS-SHAREDSERVICES-${{ upper(parameters.environment) }}

parameters:

  - name: action
    type: string
    default: plan
    values:
      - plan
      - apply

  - name: environment
    displayName: Environment
    type: string
    default: "Dev"
    values:
      - Sbox
      - Dev
      - Demo
      - Test
      - Stg
      - Prod
  
steps:

  - task: PowerShell@2
    displayName: Set terraform version env variable
    inputs:
      targetType: 'inline'
      script: |
        $tfVersion = Get-Content "$(System.DefaultWorkingDirectory)/.terraform-version" -Raw
        Write-Host "##vso[task.setvariable variable=tfVersion]$tfVersion"

  - task: TerraformInstaller@0
    displayName: 'install terraform $(tfVersion)'
    inputs:
      terraformVersion: $(tfVersion)

  - task: TerraformCLI@0
    displayName: Terraform init
    inputs:
      command: init
      terraformVersion: $(tfVersion)
      backendType: 'azurerm'
      workingDirectory: $(System.DefaultWorkingDirectory)
      backendServiceArm: $(ServiceConnection)
      backendAzureRmResourceGroupName: ${{ variables.resourceGroup }}
      backendAzureRmStorageAccountName: ${{ variables.storageAccount }}
      backendAzureRmContainerName: ${{ variables.container }}
      backendAzureRmKey: 'pre/${{ lower(parameters.environment) }}/terraform.tfstate'

  - task: TerraformCLI@0
    displayName: Terraform validate
    inputs:
      command: 'validate'
      workingDirectory: $(System.DefaultWorkingDirectory)

  - task: TerraformCLI@0
    displayName: Terraform plan
    inputs:
      command: plan
      terraformVersion: $(tfVersion)
      commandOptions: '-out=tfplan -var-file=${{ parameters.environment }}.tfvars'
      workingDirectory: $(System.DefaultWorkingDirectory)
      environmentServiceNameAzureRM: $(ServiceConnection)

  # - stage: Precheck
  #   jobs:
  #     - job: Validate
  #       pool:
  #         vmImage: ${{ variables.agentPool }}
  #         timeoutInMinutes: ${{ variables.timeoutInMinutes }}
  #       steps:
  #         - task: TerraformInstaller@0
  #           displayName: Terraform install
  #           inputs:
  #             terraformVersion: ${{ variables.tfversion }}

  # - stage: Precheck
  #   jobs:
  #     - job:
  #       pool:
  #         vmImage: ${{ variables.agentPool }}
  #         timeoutInMinutes: ${{ variables.timeoutInMinutes }}
  #       steps:
  #         - template: steps/terraform-precheck.yaml@cnp-azuredevops-libraries
  #           parameters:
  #             keyvaultName: 'infra-vault-nonprod'
  #             keyvaultSecret: 'azure-devops-token'
  #             serviceConnection: 'DCD-CFT-Sandbox'
  #             overrideAction: ${{ parameters.action }}

  # - task: TerraformCLI@0
  #   displayName: Terraform apply
  #   condition: and(succeeded(), eq('${{ parameters.Action }}', 'apply'))
  #   inputs:
  #     command: apply
  #     terraformVersion: $(tfVersion)
  #     commandOptions: '--auto-approve tfplan'
  #     workingDirectory: $(System.DefaultWorkingDirectory)
  #     environmentServiceNameAzureRM: 'devops-test-service-connection'
